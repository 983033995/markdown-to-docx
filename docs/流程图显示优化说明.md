# 流程图显示优化说明

## 问题描述

在将 Markdown 转换为 DOCX 时,Mermaid 流程图可能会出现以下问题:
- 图片超出页面宽度,显示不全
- 纵向流程图过长,被裁剪
- 图片分辨率不够,显示模糊

## 解决方案

### 方案一:图片宽度自适应(已实施)

**原理**: 在 Lua 过滤器中为生成的图片设置固定宽度 `6.5in`,这是 A4 纸张标准页边距后的可用宽度。

**优点**:
- ✅ 简单有效,无需修改 Markdown 源文件
- ✅ 自动适应 Word 页面宽度
- ✅ 保持图片比例不变形

**限制**:
- 纵向流程图高度限制为 9 英寸(约一页)
- 超过 30 行的超长流程图不限制高度,可能跨页显示

### 方案二:Mermaid 配置优化(已实施)

**配置文件**: `filters/mermaid-config.json`

**关键配置**:
```json
{
  "flowchart": {
    "useMaxWidth": true,      // 使用最大宽度
    "nodeSpacing": 50,        // 节点间距
    "rankSpacing": 50,        // 层级间距
    "wrappingWidth": 200      // 文本换行宽度
  }
}
```

**优点**:
- ✅ 优化节点布局,减少空白空间
- ✅ 自动文本换行,避免节点过宽
- ✅ 统一样式,提高可读性

### 方案三:智能复杂度检测(已实施)

**功能**:
- 自动检测流程图代码行数
- 超过 30 行的流程图不限制高度
- 输出警告信息提示可能跨页

**示例输出**:
```
处理 Mermaid 图表...
成功生成 PNG: /tmp/mermaid_1234567890_1.png
警告: 检测到超长纵向流程图(45行),可能跨页显示
```

## 使用建议

### 1. 优化流程图设计

**横向布局优于纵向**:
```mermaid
flowchart LR  # 使用 LR (Left to Right)
    A --> B --> C
```

**分解复杂流程**:
- 将大流程图拆分为多个小流程图
- 每个流程图聚焦一个子流程
- 使用文字说明连接关系

### 2. 调整图片尺寸

如果需要自定义图片尺寸,可以修改 `filters/mermaid.lua`:

```lua
-- 修改宽度(默认 6.5 英寸)
img.attributes.width = "5in"  -- 缩小到 5 英寸

-- 修改高度限制(默认 9 英寸)
img.attributes.height = "8in"  -- 缩小到 8 英寸
```

### 3. 调整画布尺寸

修改 `filters/mermaid.lua` 中的画布尺寸:

```lua
-- 纵向流程图
width = 1400   -- 默认 1400 像素
height = 2000  -- 默认 2000 像素

-- 横向流程图
width = 2000   -- 默认 2000 像素
height = 1000  -- 默认 1000 像素
```

### 4. 提高图片质量

修改分辨率倍数(默认 2 倍):

```lua
-- 在 mermaid.lua 中修改
local command = string.format(
    "mmdc -i '%s' -o '%s' -b transparent -t default -s 3 ...",  -- 改为 3 倍
    ...
)
```

**注意**: 更高的分辨率会增加文件大小和转换时间。

## 测试转换

使用示例文档测试:

```bash
cd /Volumes/13759427003/工具/markdown-to-docx
./scripts/convert.sh examples/新签二曲项目-完整文档.md
```

检查生成的 DOCX 文件中的流程图是否正常显示。

## 常见问题

### Q1: 流程图仍然显示不全怎么办?

**答**: 尝试以下方法:
1. 减小 `img.attributes.width` 的值(如改为 `5.5in`)
2. 增加画布尺寸 `width` 和 `height`
3. 优化流程图设计,减少节点数量

### Q2: 图片模糊怎么办?

**答**: 增加分辨率倍数:
- 将 `-s 2` 改为 `-s 3` 或 `-s 4`
- 注意:更高分辨率会显著增加文件大小

### Q3: 超长流程图如何处理?

**答**: 
1. **推荐**: 拆分为多个小流程图
2. **备选**: 接受跨页显示(已自动处理)
3. **手动**: 在 Word 中调整图片大小

### Q4: 如何禁用高度限制?

**答**: 注释掉高度设置代码:

```lua
-- 注释掉这两行
-- img.attributes.height = "9in"
```

## 技术细节

### 图片尺寸计算

- **A4 纸张**: 8.27 × 11.69 英寸
- **标准页边距**: 上下 1 英寸,左右 0.79 英寸
- **可用宽度**: 8.27 - 0.79 × 2 = 6.69 英寸
- **安全宽度**: 6.5 英寸(留出余量)

### Mermaid CLI 参数

```bash
mmdc -i input.mmd \      # 输入文件
     -o output.png \     # 输出文件
     -b transparent \    # 透明背景
     -t default \        # 默认主题
     -s 2 \              # 2倍分辨率
     -w 1400 \           # 宽度 1400px
     -H 2000 \           # 高度 2000px
     -c config.json      # 配置文件
```

## 更新日志

- **2024-11-21**: 实施三种优化方案
  - 添加图片宽度自适应
  - 创建 Mermaid 配置文件
  - 实现智能复杂度检测

## 参考资料

- [Mermaid 官方文档](https://mermaid.js.org/)
- [Pandoc 图片处理](https://pandoc.org/MANUAL.html#images)
- [Mermaid CLI 文档](https://github.com/mermaid-js/mermaid-cli)
